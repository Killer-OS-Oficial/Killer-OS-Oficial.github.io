{"hash":"ec202a1bf990ee54ab5e1ace734762290dcb6831","data":{"markdownPage":{"id":"25bc1a47c783d36c0b02a08d48cbe76b","title":"Instalación de btrfs","description":"Manual para instalar Arch Linux en btrfs.","date":null,"date_up":"13.08.2020","path":"/wiki/btrfs/btrfs-part1/","timeToRead":5,"content":"<h1 id=\"instalación-y-uso-de-btrfs\"><a href=\"#instalaci%C3%B3n-y-uso-de-btrfs\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Instalación y uso de Btrfs</h1>\n<h2 id=\"comenzando\"><a href=\"#comenzando\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>comenzando</h2>\n<p>Instale el paquete de utilidades personalizadas.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">pacman -S btrfs-progs arch-install-scripts</code></pre>\n<p><code>lsblk</code> - lista todas las secciones para decidir qué montar.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># disco de partición, -z dice poner a cero la tabla de particiones</span>\n<span class=\"token function\">cfdisk</span> -z /dev/sda</code></pre>\n<p>Dado que Btrfs no puede contener un archivo de intercambio, debe ocuparse de la partición de intercambio con anticipación si la necesita.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkswap</span> /dev/sda2</code></pre>\n<p>Creamos un sistema de archivos en la partición. Para particiones de 1GB y más pequeñas, para usar el espacio de manera más eficiente, se recomienda pasar el interruptor -M a los parámetros <code>mkfs.btrfs</code>.</p>\n<p>Opcionalmente, puede configurar la etiqueta con la tecla -L.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">mkfs.btrfs /dev/sda<span class=\"token operator\">&lt;</span>número<span class=\"token operator\">></span>\nmkfs.btrfs -L <span class=\"token string\">\"root\"</span> /dev/sda<span class=\"token operator\">&lt;</span>número<span class=\"token operator\">></span></code></pre>\n<p>Ahora montamos.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mount</span> /dev/sdb1 /mnt</code></pre>\n<p>Luego crearemos dos subvolúmenes para los directorios de inicio de usuario y raíz.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">btrfs subvolume create /mnt/@\nbtrfs subvolume create /mnt/@home</code></pre>\n<p>Visualización de subvolúmenes.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">btrfs subvolume list /mnt</code></pre>\n<p>Desmontemos la raíz FS.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">umount</span> /mnt</code></pre>\n<p>Para montar un subvoltaje como una partición de disco normal, el comando mount necesita especificar la opción subvol.</p>\n<p>Monte la raíz. Compresión zstd o lzo.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mount</span> -o <span class=\"token assign-left variable\">subvol</span><span class=\"token operator\">=</span>@,compress<span class=\"token operator\">=</span>zstd /dev/sdb1 /mnt</code></pre>\n<p>Cree un directorio y monte nuestro futuro directorio de usuarios en él.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> /mnt/home\n<span class=\"token function\">mount</span> -o <span class=\"token assign-left variable\">subvol</span><span class=\"token operator\">=</span>@home,compress<span class=\"token operator\">=</span>zstd /dev/sdb1 /mnt/home</code></pre>\n<p>Luego actuamos en la wiki, es decir elija espejos e instale el sistema base. Al generar initramfs, mkinitcpio se quejará de la ausencia de fsck.btrfs; esto es normal. Eliminemos este gancho fsck de la configuración, porque no es necesario para Btrfs.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">nano</span> /etc/mkinitcpio.conf</code></pre>\n<p>Aquí está la línea dada en el archivo.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">HOOKS</span><span class=\"token operator\">=</span><span class=\"token string\">\"base udev autodetect modconf block filesystems keyboard\"</span></code></pre>\n<p>Y vuelva a crear initramfs.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">mkinitcpio -p linux</code></pre>\n<p>Y una cosa más sobre el gestor de arranque, no sé cómo otros, pero grub definitivamente sabe cómo arrancar desde Btrfs, así que es mejor elegirlo. Además, no olvide instalar el paquete btrfs-progs y hacerse cargo de las copias de seguridad.</p>\n<hr>\n<h2 id=\"usando-btrfs\"><a href=\"#usando-btrfs\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Usando btrfs</h2>\n<p>Monte la raíz FS.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mount</span> /dev/sdb1 /mnt</code></pre>\n<p>Crea instantáneas.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">btrfs subvolume snapshot /mnt/@ /mnt/@_bac\nbtrfs subvolume snapshot /mnt/@home /mnt/@home_bac\n\nbtrfs subvolume list /mnt</code></pre>\n<p>Los directorios son absolutamente idénticos y, hasta que empezamos a cambiar los archivos, las instantáneas no ocupan espacio.</p>\n<p>Eliminando.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">btrfs subvolume delete /mnt/@</code></pre>\n<p>Rollback: arranque desde el Live CD, monte la raíz FS y cambie el nombre de los subvolúmenes. Los subvolúmenes también se pueden renombrar directamente en el sistema de producción si la descarga se realiza correctamente.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mount</span> /dev/sdb1 /mnt\n<span class=\"token function\">mv</span> /mnt/@ /mnt/@_bad\n<span class=\"token function\">mv</span> /mnt/@_bac /mnt/@\n\n<span class=\"token function\">mv</span> /mnt/@home /mnt/@home_bad\n<span class=\"token function\">mv</span> /mnt/@home_bac /mnt/@home</code></pre>\n<p>O arrancamos como de costumbre, y en el menú de grub especificamos el subvolumen con la copia de seguridad <code>rootflags=subvol=backup</code>.</p>\n<p>Copia en escritura (CoW). Si usa el comando <code>cp</code> con llave <code>--reflink=auto</code>, entonces la copia del archivo no ocupará espacio en disco. Y más tarde, por ejemplo, cuando se cambia el archivo copiado, solo se escribirán en el disco los bloques modificados.</p>\n<p>\"Online\" - Comprobación de FS. En el que todos los datos / metadatos se leen con la verificación de sumas de verificación, si hay errores, se detectan y corrigen si es posible.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">btrfs scrub start -B /</code></pre>\n<p>Si omite el modificador <code>-B</code>, el proceso pasará a segundo plano y el comando podrá averiguar sobre el progreso de la ejecución.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">btrfs scrub status /</code></pre>\n<p>Salida de muestra.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">scrub status <span class=\"token keyword\">for</span> 56edc366-a153-4eee-b2a6-471b7066b93d\nscrub started at Sat Dec <span class=\"token number\">14</span> 06:37:19 <span class=\"token number\">2013</span> and finished after <span class=\"token number\">3242</span> seconds\ntotal bytes scrubbed: <span class=\"token number\">222</span>.45GB with <span class=\"token number\">0</span> errors</code></pre>\n<p>Se recomienda verificarlo regularmente (semanalmente). \"Fuera de línea\": comprobación de FS (en la partición desmontada). Si no hay errores, la utilidad devolverá 0.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">btrfs check /dev/sda</code></pre>\n<hr>\n<h2 id=\"instalar-desde-un-sistema-existente-o-desde-un-usb-en-vivo\"><a href=\"#instalar-desde-un-sistema-existente-o-desde-un-usb-en-vivo\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Instalar desde un sistema existente o desde un usb en vivo</h2>\n<pre class=\"language-bash\"><code class=\"language-bash\">pacman -S btrfs-progs arch-install-scripts</code></pre>\n<p><code>lsblk</code> - resalte todas las secciones para decidir qué montar.</p>\n<p>Dado que Btrfs no puede contener un archivo de intercambio, debe ocuparse de la partición de intercambio con anticipación si la necesita.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkswap</span> /dev/sda2</code></pre>\n<p>¡Atención! esto formateará todo su disco, ¡con pérdida de datos! En este ejemplo, la instalación va a todo el disco, no a las particiones, si necesita un intercambio, considere este punto.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">mkfs.btrfs -f -L WD /dev/sdb</code></pre>\n<p>Montamos.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mount</span> /dev/sdb /mnt</code></pre>\n<p>Creemos dos subvolúmenes bajo la raíz <code>@</code> y el directorio de inicio del usuario <code>@ home</code>.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">btrfs subvolume create /mnt/@\nbtrfs subvolume create /mnt/@home</code></pre>\n<p>Y desmonte la raíz FS.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">umount</span> /mnt</code></pre>\n<p>Monte la raíz.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mount</span> -o <span class=\"token assign-left variable\">subvol</span><span class=\"token operator\">=</span>@,compress<span class=\"token operator\">=</span>zstd /dev/sdb /mnt</code></pre>\n<p>Cree un directorio y monte nuestro futuro directorio de usuarios en él.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> /mnt/home\n<span class=\"token function\">mount</span> -o <span class=\"token assign-left variable\">subvol</span><span class=\"token operator\">=</span>@home,compress<span class=\"token operator\">=</span>zstd /dev/sdb /mnt/home</code></pre>\n<p>Instale paquetes básicos.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">pacstrap /mnt base base-devel linux linux-headers xorg-xinit xorg-server grub <span class=\"token function\">zsh</span> <span class=\"token function\">mc</span> <span class=\"token function\">nano</span> netctl wpa_supplicant dialog dhcpcd btrfs-progs</code></pre>\n<p>Creamos fstab.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">genfstab -pU /mnt <span class=\"token operator\">>></span> /mnt/etc/fstab</code></pre>\n<p>Comprobación.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">cat</span> /mnt/etc/fstab</code></pre>\n<p>Cree un directorio y monte el arranque si es necesario.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mount</span> -t proc none /mnt/proc\n<span class=\"token function\">mount</span> -t sysfs none /mnt/sys\n<span class=\"token function\">mount</span> -o <span class=\"token builtin class-name\">bind</span> /dev /mnt/dev\n\n<span class=\"token function\">cp</span> -L /etc/resolv.conf /mnt/etc\n\n<span class=\"token function\">swapon</span> /dev/sda2</code></pre>\n<p>A partir del kernel 5.0, puede crear un archivo de intercambio, el archivo de intercambio debe estar ubicado completamente en un dispositivo, creado con COW deshabilitado y compresión.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">touch</span> /swap             <span class=\"token comment\"># crear un archivo / intercambio vacío</span>\n<span class=\"token function\">chmod</span> go-r /swap        <span class=\"token comment\"># el intercambio debe ser 600</span>\nchattr +C /swap         <span class=\"token comment\"># apagar COW, la compresión también se apaga</span>\nfallocate /swap -l4g    <span class=\"token comment\"># Archivo 4Gb</span>\n<span class=\"token function\">mkswap</span> /swap\n<span class=\"token function\">swapon</span> /swap</code></pre>\n<p>Vamos a revisar.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">btrfs subvolume list /mnt</code></pre>\n<p>Entramos en el sistema.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">chroot</span> /mnt /bin/zsh</code></pre>\n<p>Asignamos un anfitrión.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> ctlos <span class=\"token operator\">></span> /etc/hostname</code></pre>\n<p>Selección de zona horaria.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">ln</span> -sf /usr/share/zoneinfo/UTC /etc/localtime\nhwclock --systohc --utc\ntimedatectl set-ntp <span class=\"token boolean\">true</span>\n<span class=\"token comment\"># o</span>\ntimedatectl set-timezone America/Mexico</code></pre>\n<p>Elija una configuración regional para el sistema.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sed</span> -i <span class=\"token string\">\"s/#\\(es_MX\\.UTF-8\\)/<span class=\"token entity\" title=\"\\1\">\\1</span>/\"</span> /etc/locale.gen\n\nlocale-gen         <span class=\"token comment\"># Generar locales</span></code></pre>\n<p>Registrarse en<code>/etc/locale.conf</code>.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"LANG=es_MX.UTF-8\"</span> <span class=\"token operator\">></span> /etc/locale.conf\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"LC_COLLATE=C\"</span> <span class=\"token operator\">>></span> /etc/locale.conf</code></pre>\n<p>Fuente en Español en la consola.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"KEYMAP=es\"</span> <span class=\"token operator\">></span> /etc/vconsole.conf</code></pre>\n<p>Cree un disco de marco mkinitcpio.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">nano</span> /etc/mkinitcpio.conf</code></pre>\n<p>En <code>/ etc / mkinitcpio.conf</code>, en la sección <strong>HOOKS</strong>, el<code>mapa de teclas</code> del teclado del gancho debe estar registrado, elimine<code>fsck</code>.</p>\n<p>En la sección <strong>MÓDULOS </strong>, debe registrar el controlador de su tarjeta de video: i915 para Intel, radeon para AMD, nouveau para Nvidia.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">HOOKS</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>base udev autodetect modconf block filesystems keyboard keymap<span class=\"token punctuation\">)</span></code></pre>\n<pre class=\"language-bash\"><code class=\"language-bash\">mkinitcpio -p linux</code></pre>\n<p>Establecer contraseña de root.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">passwd</span></code></pre>\n<p>Crear usuario.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">useradd</span> -m -g <span class=\"token function\">users</span> -G wheel,audio,video,storage -s /bin/zsh killer</code></pre>\n<p>Y pídale una contraseña.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">passwd</span> killer</code></pre>\n<p>Descomente en <code>/ etc / pacman.conf</code>.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>multilib<span class=\"token punctuation\">]</span>\nInclude <span class=\"token operator\">=</span> /etc/pacman.d/mirrorlist</code></pre>\n<p>Luego ejecuta.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">pacman-key --init\npacman-key --populate\npacman -Syy</code></pre>\n<p>Instalación del cargador de arranque.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">grub-install /dev/sdb\n<span class=\"token function\">grub-mkconfig</span> -o /boot/grub/grub.cfg</code></pre>\n<p>Configuración de sudo.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">EDITOR</span><span class=\"token operator\">=</span>nano visudo</code></pre>\n<p>Otorgue al usuario privilegios de superusuario o grupo cuando escriba sudo.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">malody <span class=\"token assign-left variable\">ALL</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>ALL<span class=\"token punctuation\">)</span> ALL</code></pre>\n<p>O un grupo.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">%wheel <span class=\"token assign-left variable\">ALL</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>ALL<span class=\"token punctuation\">)</span> ALL</code></pre>\n<p>Para no solicitar una contraseña al usuario.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">Defaults:malody      <span class=\"token operator\">!</span>authenticate</code></pre>\n","sidebar":"wiki","next":"/wiki/btrfs/btrfs-part2/","prev":"","headings":[{"depth":1,"value":"Instalación y uso de Btrfs","anchor":"#instalación-y-uso-de-btrfs"},{"depth":2,"value":"comenzando","anchor":"#comenzando"},{"depth":2,"value":"Usando btrfs","anchor":"#usando-btrfs"},{"depth":2,"value":"Instalar desde un sistema existente o desde un usb en vivo","anchor":"#instalar-desde-un-sistema-existente-o-desde-un-usb-en-vivo"}]},"allMarkdownPage":{"edges":[{"node":{"path":"/wiki/changelog/bspwm-1-0/","title":"Bspwm 1.0B"}},{"node":{"path":"/wiki/wm/bspwm/","title":"Killer-OS Bspwm"}},{"node":{"path":"/wiki/packages/other-pkg/","title":"Añadir. programas"}},{"node":{"path":"/wiki/packages/iwd/","title":"Iwd wifi"}},{"node":{"path":"/wiki/other/screencast/","title":"Screencast"}},{"node":{"path":"/wiki/other/notes/","title":"Notas"}},{"node":{"path":"/wiki/other/grub-uefi/","title":"Grub UEFI"}},{"node":{"path":"/wiki/other/gnupg/","title":"Gnupg"}},{"node":{"path":"/wiki/other/git-start/","title":"Git Start"}},{"node":{"path":"/wiki/config/videocfg/","title":"Видео драйвера"}},{"node":{"path":"/wiki/config/trouble/","title":"Решение проблем"}},{"node":{"path":"/wiki/config/ssh/","title":"Настройка ssh"}},{"node":{"path":"/wiki/config/autologin/","title":"Автологин"}},{"node":{"path":"/wiki/config/recomend/","title":"Рекомендации"}},{"node":{"path":"/wiki/changelog/","title":"Changelog"}},{"node":{"path":"/wiki/btrfs/btrfs-part2/","title":"Btrfs Continuar"}},{"node":{"path":"/wiki/btrfs/btrfs-part1/","title":"Instalación de btrfs"}},{"node":{"path":"/wiki/backup/timeshift-rsync/","title":"Timeshift, rsync"}},{"node":{"path":"/wiki/backup/squashfs/","title":"Squashfs"}},{"node":{"path":"/wiki/backup/netcat/","title":"Netcat, ssh, rsync"}},{"node":{"path":"/wiki/whois/","title":"Brevemente sobre Killer-OS Linux"}},{"node":{"path":"/wiki/","title":"Killer-OS Linux Wiki"}}]}},"context":{}}